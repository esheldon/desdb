#!/bin/bash
# Download DES red or coadd files. 
#
#  usage:  wget-des [-d dir] type run band
#
# type is the file type, "red" or "coadd" "raw"
# band is ignored for type = "raw"
#
# Data are copied from
#
#    ftp://desar.cosmology.illinois.edu/DESFiles/desardata/DES/{type}/${run}/{type}/...
#
# By default, data are copied under the $DESDATA directory
#
#   $DESDATA/{type}/${run}/{type}/...
# 
# But an alternative prefix to the environment variable $DESDATA can be
# specified with the -d keyword
#
# Author
#   Erin Sheldon, Brookhaven National Laboratory
#

function usage_and_exit {
    echo "
Usage 
        wget-des [options] type run band

Description

        Download images and catalogs for the input file type, run identifier
        and band.  The data are, by default, downloaded from

            \$DESREMOTE/{type}/{run}/{type} 
        
        and downloaded to 
        
            \$DESDATA/{type}/{run}/{type} 
        
        where \$DESDATA is an environment variable pointing to the base of your
        DES data area and DESREMOTE is the url of the server. You can send the
        -d keyword to specify an alternative to \$DESDATA, or -r for
        analternative to DESREMOTE.

        The exception is for type 'raw' for which the relevant environment
        variables are DTSDATA and DTSREMOTE.  Also, the directory for
        raw images is \$DTSDATA/src/{run}/src
        
Arguments
        type: one of 'red' 'coadd' 'raw'
            note 'commsrc' also works for raw
        run:  The run identifier
        band: g,r,i,z,Y
            ignored for raw
Options
        -d The download directory. defaults to \$DESDATA environment
           variable.
        -r The remote directory. defaults to \$DESREMOTE  environment
           variable.
"
    exit 45
}

if [[ $# -lt 3 ]]; then
    echo "send 3 args"
    usage_and_exit
fi

dir=""
remote_dir=""
while getopts "d:r:" Option
  do
  case $Option in
      d)  dir=$OPTARG ;;
      r)  remote_dir=$OPTARG ;;
      [?]) echo "bad option"; usage_and_exit ;;
  esac
done
shift $(($OPTIND - 1))

download_type="$1"
run="$2"
band=$3

if [[ $download_type == "commsrc" ]]; then
    download_type="raw"
fi

if [[ $download_type == "raw" ]]; then
    if [[ $dir == "" ]]; then
        if [[ ${DTSDATA:+1} == "" ]]; then
            echo "For raw, either send -d or set the DTSDATA "
            echo "environment variable"
            exit 45
        fi
        dir="$DTSDATA"
    fi
    if [[ $remote_dir == "" ]]; then
        if [[ ${DTSREMOTE:+1} == "" ]]; then
            echo "For raw, either send -r or set the DTSREMOTE "
            echo "environment variable is set"
            exit 45
        fi
        remote_dir="$DTSREMOTE"
    fi
else
    if [[ $dir == "" ]]; then
        if [[ ${DESDATA:+1} == "" ]]; then
            echo "Either send -d dir or set the DESDATA "
            echo "environment variable"
            exit 45
        fi
        dir="$DESDATA"
    fi
    if [[ $remote_dir == "" ]]; then
        if [[ ${DESREMOTE:+1} == "" ]]; then
            echo "Either send -r remote_dir or set the DESREMOTE "
            echo "environment variable"
            exit 45
        fi
        remote_dir="$DESREMOTE"
    fi
fi


case $download_type in
    "red") 
        accept="*-${band}-*[0-9].fits.fz,*-${band}-*_cat.fits"
        type="red"
        ;;
    "coadd")
        accept="*${band}.fits.fz,*${band}_cat.fits"
        type="coadd"
        ;;
    "raw")
        accept="*.fits.fz"
        type="src"
        dir=$dir/comm 
        ;;
      *) usage_and_exit
        ;;
esac

url="${remote_dir}/${type}/${run}/${type}"
echo "
    type:    $type
    run:     $run
    band:    $band
    url:     $url
    dir:     $dir
"

echo "chdir to dir $dir"
cd "$dir"
if [[ "$?" != "0" ]]; then
    echo "Failed to chdir to: $dir"
    exit 45
fi

# No following slash on URL or it won't work!
# -c means continue downloading, as opposed to name.1 business
# -nH no host directories
# use -nv for non-verbose 
#    --progress=dot:mega     \
wget                        \
    -c                      \
    -nv                     \
    --mirror                \
    -nH                     \
    --cut-dirs=3            \
    --no-parent             \
    --tries 50              \
    --accept "$accept"      \
    "$url"
